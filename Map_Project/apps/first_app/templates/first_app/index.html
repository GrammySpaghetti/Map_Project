<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title>Map Project</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.4/dist/leaflet.css" integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA==" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.3.4/dist/leaflet.js" integrity="sha512-nMMmRyTVoLYqjP9hrbed9S+FzjZHW5gY1TWCHA5ckwXZBadntCNs8kEqAWdrb9O7rxbCaA4lKTIWjDXZxflOcA==" crossorigin=""></script>
  </head>
  <body>
    {% if messages %}
        {% for message in messages %}
            <p class='text-success'>{{message}}</p>
        {% endfor %}
    {% endif %}
    <div class='row bg-primary'>
      <h1 class='d-inline-block col-lg-8 ml-5 text-white'>Hello {{ user.first_name }}!</h1>
      <a class='d-inline-block text-white ml-5' href="/logout/">Logout</a>
      <p class='d-inline-block text-white'>||</p>
      <a class='d-inline-block text-white' href="/jobs/new/">New Job</a>
    </div>
    <table class="table table-striped table-fixed col-lg-5 d-inline-block m-2" id='data_table'>
      <!-- <h4 class='ml-2'>Map Nodes:</h4> -->
        <thead class="thead-dark">
            <tr>
                <th scope="col">Node Points</th>
                <!-- <th scope="col">Description</th>
                <th scope="col">Location</th>
                <th scope="col">Created By:</th> -->
            </tr>
        </thead>
        <tbody>
            {% for i in nodes %}
                <tr id='{{i.id}}'>
                    <th scope="row" class='myClass'>Node Title: {{i.title}}</th>
                    <td class='myClass'>Description: {{ i.desc }}</td>
                    <td class='myClass'>Lat: {{ i.lat }} || Long: {{ i.long }}</td>
                    <td class='myClass'>Created By: </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>

    <div id="mapid" class="col-lg-6 d-inline-block align-top m-2" style='height: 560px'></div>


    <script type="text/javascript">
      var mymap = L.map('mapid').setView([36, -100], 4);
      var hikeIcon = L.icon({
        iconUrl: "../../static/first_app/img/hiking.png",
        iconSize: [32, 37],
        iconAnchor: [19, 36],
        popupAnchor: [-3, -31],
      })
      var popup = L.popup({
        minWidth: 300
      });

      function onMapClick(e) {
        popup
          .setLatLng(e.latlng)
          .setContent(
            `<form action='/process/' class='form-group' method='POST'>
            {% csrf_token %}
            <input class='row form-control' type='text' name='title' placeholder='Title'>
            <textarea class='row form-control' rows='3' name='desc' placeholder='Description'></textarea>
            <input type='hidden' name='lat' value='${e.latlng.lat.toFixed(4)}'>
            <input type='hidden' name='long' value='${e.latlng.lng.toFixed(4)}'>
            <button type='submit' value='submit' class='btn btn-dark'>Add</button>
            </form>`
          )
          .openOn(mymap);
      }
      mymap.on('click', onMapClick);


      L.tileLayer('https://{id}.tile.opentopomap.org/{z}/{x}/{y}.png', {
        attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, map style: Â© <a href="https://www.opentopomap.org/">OpenTopoMap</a>',
        id: 'c',
        maxZoom: '17',
      }).addTo(mymap);

      var markers = {};
      function drawNode(){
        var myItems = [
          {% for node in nodes %}
          ['{{node.desc}}', {{node.lat}}, {{node.long}}, '{{node.title}}', '{{node.id}}'],
          {% endfor %}
        ]
        for (var i = 0; i < myItems.length; i++) {
            var item = myItems[i];

            var marker = new L.marker([item[1],item[2]], {
              icon: hikeIcon,
              url: item[4]
            }).bindPopup(`<h6>Title: ${item[3]}</h6><p>Description: ${item[0]}</p>`).addTo(mymap);
            markers[item[4]] = marker;
            marker.on('click', onClick);

            console.log(marker)
        }
      }
      drawNode();

      $('tr').click(function(){
        var row = document.getElementsByClassName('table-success');
        if(row[0]){
          row[0].className = '';
        };
        markers[this.id].openPopup();

        // tableSelect($(this)[0].id);
        this.className = 'table-success';
      });

      function onClick(e) {
        var row = document.getElementsByClassName('table-success');
        if(row[0]){
          row[0].className = '';
        };
        var get = document.getElementById(this.options.url);
        get.scrollIntoView();
        get.className = 'table-success';
      }

      $(window).on("resize", function() {
          $("#mapid").height($(window).height()).width($(window).width());
          mymap.invalidateSize();
      }).trigger("resize");




    </script>
  </body>
  <style>
    .table-fixed thead {
    width: 100%;
    }
    .table-fixed tbody {
      height: 560px;
      overflow-y: auto;
      width: 100%;
    }
    .table-fixed thead, .table-fixed tbody, .table-fixed tr, .table-fixed td, .table-fixed th {
      display: block;
    }
  </style>
</html>
